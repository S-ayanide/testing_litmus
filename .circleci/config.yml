version: 2.1

workflows:
  setup-minikube:
    jobs:
      - setup-minikube

jobs:
  setup-minikube:
    machine:
      image: circleci/classic:201808-01
      docker_layer_caching: true

    environment:
      K8S_VERSION: v1.12.0
      KUBECONFIG: /home/circleci/.kube/config
      MINIKUBE_VERSION: v0.31.0
      MINIKUBE_WANTUPDATENOTIFICATION: false
      MINIKUBE_WANTREPORTERRORPROMPT: false
      MINIKUBE_HOME: /home/circleci
      CHANGE_MINIKUBE_NONE_USER: true
    
    steps:
      - checkout
      - run:
          name: Setup kubectl
          command: |
            curl -Lo kubectl https://storage.googleapis.com/kubernetes-release/release/${K8S_VERSION}/bin/linux/amd64/kubectl && chmod +x kubectl && sudo mv kubectl /usr/local/bin/
            mkdir -p ${HOME}/.kube
            touch ${HOME}/.kube/config
      - run:
          name: Setup minikube
          command: |
            curl -Lo minikube https://github.com/kubernetes/minikube/releases/download/${MINIKUBE_VERSION}/minikube-linux-amd64 && chmod +x minikube && sudo mv minikube /usr/local/bin/
      - run:
          name: Start minikube
          command: |
            sudo -E minikube start --vm-driver=none --cpus 2 --memory 4096 --kubernetes-version=${K8S_VERSION}
      - run:
          name: wait for minikube
          command: |
            JSONPATH='{range .items[*]}{@.metadata.name}:{range @.status.conditions[*]}{@.type}={@.status};{end}{end}';
            until kubectl get nodes -o jsonpath="$JSONPATH" 2>&1 | grep -q "Ready=True"; do
              sleep 1;
            done
      - run:
          name: fix RBAC
          command: |
            # make default account cluster-admin
            kubectl create clusterrolebinding add-on-cluster-admin --clusterrole cluster-admin --serviceaccount=kube-system:default
      - run:
          name: dump cluster-info
          command: |
            kubectl cluster-info
            kubectl get po --all-namespaces
      - run:
          name: Setup kubeconfig ENV for Chaos Action
          command: echo ::set-env name=KUBE_CONFIG_DATA::$(base64 -w 0 ~/.kube/config)
      - run:
          name: Deploying a sample application (NGINX)
          command: |
            kubectl apply -f https://raw.githubusercontent.com/mayadata-io/chaos-ci-lib/master/app/nginx.yml
            sleep 30
      - run:
          name: Running pod-delete
          command: |
            echo "export INSTALL_LITMUS=true" >> $BASH_ENV
            echo "export EXPERIMENT_NAME=pod-delete" >> $BASH_ENV
            echo "export EXPERIMENT_IMAGE=litmuschaos/ansible-runner" >> $BASH_ENV
            echo "export EXPERIMENT_IMAGE_TAG=ci" >> $BASH_ENV
            echo "export IMAGE_PULL_POLICY=IfNotPresent" >> $BASH_ENV
            echo "export LITMUS_CLEANUP=true" >> $BASH_ENV
            source $BASH_ENV
            sleep 30
            docker run litmuschaos/chaos-ci-lib entrypoint="./pod-delete"
